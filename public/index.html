<!DOCTYPE html>
<html>
<head>
	<title>URL Shortener</title>
	<style type="text/css">
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		body {
			font-family: "Raleway", sans-serif;
		}
		.header {
			width: 100%;
			height: 50px;
			line-height: 50px;
			text-align: center;
			background: #111;
			color: #eee;
			font-weight: 600;
		}
		.form {
			padding: 50px 20px;
			background: #d2e9f7;
			text-align: center;
		}
		.form > div {
			width: 400px;
			margin: 10px auto;
		}
		.form .form-element input,
		.form .form-element button {
			width: 100%;
			padding: 10px;
			margin-top: 10px;
		}
		.form .form-element button {
			background: #111;
			color: #eee;
			outline: none;
			border: none;
			cursor: pointer;
		}
		.form .result {
			text-align: center;
			margin-top: 15px;
		}
		.list {
			width: 800px;
			margin: 40px auto;
			text-align: center;
		}
		.list h2 {
			font-size: 30px;
			margin-bottom: 20px;
		}
		.list table {
			width: 100%;
			border-collapse: collapse;
		}
		.list table th, .list table td {
			padding: 10px;
			border: 1px solid #ccc;
			text-align: center;
		}
		.list table thead {
			background: #555;
			color: #fff;
		}
		.list table tbody tr:nth-child(odd) {
			background: #eee;
		}
	</style>
</head>
<body>
	<div class="header">
		URL Shortener
	</div>

	<div class="form">
		<div class="form-element">
			<label for="longurl">Enter URL</label>
			<input type="text" id="longurl" placeholder="https://example.com">
		</div>
		<div class="form-element">
			<button id="create-short-url">Generate Short URL</button>
		</div>
		<div class="result">
			<a href="#" id="short-url" target="_blank"></a>
		</div>
	</div>

	<div class="list">
		<h2>Shortened Links</h2>
		<table id="list_urls">
			<thead>
				<tr>
					<th>Long URL</th>
					<th>Short URL</th>
					<th>Visits</th>
				</tr>
			</thead>
			<tbody></tbody>
		</table>
	</div>

	<script type="text/javascript">
		const host = "http://localhost:5000/";

		document.querySelector("#create-short-url").addEventListener("click", async function() {
			let longurl = document.querySelector("#longurl").value.trim();

			// Improved URL validation
			try {
				new URL(longurl);
			} catch (e) {
				alert("Please enter a valid URL (starting with http:// or https://)");
				return;
			}

			try {
				let response = await fetch(host + "api/create-short-url", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({ longurl })
				});
				let data = await response.json();

				if (data.status === "ok") {
					const shortUrl = `${host}${encodeURIComponent(data.shorturl)}`;
					document.querySelector("#short-url").innerText = shortUrl;
					document.querySelector("#short-url").href = shortUrl;

					// Add new row to the table
					let newRow = `
						<tr>
							<td>${longurl}</td>
							<td><a href="${shortUrl}" target="_blank">${shortUrl}</a></td>
							<td>0</td>
						</tr>`;
					document.querySelector("#list_urls tbody").insertAdjacentHTML("beforeend", newRow);
				} else {
					alert("Error creating short URL");
				}
			} catch (error) {
				alert("Something went wrong. Please try again.");
			}
		});

		// Fetch existing short URLs
		(async function() {
			try {
				let response = await fetch(host + "api/get-all-short-urls");
				let data = await response.json();
				let html = data.map(row => `
					<tr>
						<td>${row.longurl}</td>
						<td><a href="${host}${encodeURIComponent(row.shorturl)}" target="_blank">${host}${row.shorturl}</a></td>
						<td>${row.count}</td>
					</tr>
				`).join("");
				document.querySelector("#list_urls tbody").innerHTML = html;
			} catch (error) {
				alert("Could not fetch URLs.");
			}
		})();
	</script>
</body>
</html>
